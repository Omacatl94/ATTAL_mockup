<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Nostre Filiali - ATTAL Group | 88 Sedi in Tutta Italia</title>
    <meta name="description" content="Trova la filiale ATTAL più vicina a te. 88 sedi in Italia tra Temporary, Tempor, Tempus e Lavorint. Vieni a trovarci per colloqui e consulenza gratuita.">

    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/pages/filiali.css">
</head>
<body>
    <!-- Header incluso dinamicamente -->
    <div id="header-placeholder"></div>

    <!-- HERO SECTION - GEOLOCALIZZAZIONE -->
    <section class="hero">
        <div class="container">
            <h1>Trova la filiale più vicina a te</h1>
            <p class="subtitle">88 sedi in Italia, scopri quella vicino a casa tua</p>

            <button class="geo-btn" id="geoBtn" onclick="trovaFilialeVicina()">
                <span class="geo-icon"><i data-lucide="map-pin"></i></span>
                <span class="geo-text">Trova filiale vicina</span>
            </button>

            <!-- Alert se nessuna filiale vicina -->
            <div class="geo-alert" id="geoAlert" style="display: none;">
                <div class="geo-alert-icon"><i data-lucide="alert-triangle"></i></div>
                <div class="geo-alert-content">
                    <h3>Nessuna filiale nei dintorni immediati</h3>
                    <p>Ma non preoccuparti! Abbiamo <strong>1331 offerte di lavoro</strong> disponibili.</p>
                    <div class="geo-alert-actions">
                        <a href="attal-careers_8.html" class="geo-alert-btn primary"><i data-lucide="search"></i> Cerca offerte vicine</a>
                        <button class="geo-alert-btn secondary" onclick="scrollToManualSearch()"><i data-lucide="map-pin"></i> Sfoglia tutte le filiali</button>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- MAPPA + FILTRI -->
    <section class="filiali-section">
        <div class="container">
            <div class="filiali-wrapper">
                <!-- SIDEBAR FILTRI -->
                <aside class="filtri-sidebar">
                    <h3><i data-lucide="sliders-horizontal"></i> Cerca e filtra</h3>

                    <div class="filter-group">
                        <label><i data-lucide="search"></i> Cerca</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" class="filter-input" id="searchInput" placeholder="Città o provincia..." autocomplete="off">
                            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label><i data-lucide="map-pin"></i> Regione</label>
                        <select id="regioneFilter" onchange="filterFiliali()">
                            <option value="">Tutte le regioni</option>
                            <option value="Lombardia">Lombardia</option>
                            <option value="Lazio">Lazio</option>
                            <option value="Piemonte">Piemonte</option>
                            <option value="Veneto">Veneto</option>
                            <option value="Emilia-Romagna">Emilia-Romagna</option>
                            <option value="Toscana">Toscana</option>
                            <option value="Puglia">Puglia</option>
                            <option value="Campania">Campania</option>
                            <option value="Liguria">Liguria</option>
                            <option value="Marche">Marche</option>
                            <option value="Calabria">Calabria</option>
                            <option value="Sicilia">Sicilia</option>
                            <option value="Sardegna">Sardegna</option>
                            <option value="Abruzzo">Abruzzo</option>
                            <option value="Friuli-Venezia Giulia">Friuli-Venezia Giulia</option>
                            <option value="Umbria">Umbria</option>
                            <option value="Basilicata">Basilicata</option>
                            <option value="Molise">Molise</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label><i data-lucide="building-2"></i> Brand</label>
                        <select id="brandFilter" onchange="filterFiliali()">
                            <option value="">Tutti i brand</option>
                            <option value="Temporary">Temporary</option>
                            <option value="Tempor">Tempor</option>
                            <option value="Tempus">Tempus</option>
                            <option value="Lavorint">Lavorint</option>
                        </select>
                    </div>

                    <!-- INFO BOX FILIALE SIDEBAR -->
                    <div class="sidebar-info-box" id="sidebarInfoBox">
                        <div class="sidebar-info-header">
                            <div class="sidebar-info-title-row">
                                <div class="sidebar-info-title" id="sidebarTitle">Seleziona una filiale</div>
                                <span class="sidebar-brand-badge" id="sidebarBrand" style="background: #e22721">-</span>
                            </div>
                            <div class="sidebar-rating">
                                <span class="sidebar-stars" id="sidebarStars">★★★★★</span>
                                <span class="sidebar-rating-num" id="sidebarRating">-</span>
                                <span style="color: #9ca3af; font-size: 11px;" id="sidebarCount">(-)</span>
                            </div>
                        </div>
                        <div class="sidebar-info-body">
                            <div class="sidebar-detail">
                                <span class="sidebar-icon"><i data-lucide="map-pin"></i></span>
                                <span id="sidebarAddress">-</span>
                            </div>
                            <div class="sidebar-detail">
                                <span class="sidebar-icon"><i data-lucide="phone"></i></span>
                                <a href="tel:" id="sidebarPhone">-</a>
                            </div>
                            <div class="sidebar-detail">
                                <span class="sidebar-icon"><i data-lucide="clock"></i></span>
                                <span>Lun-Ven 9:00-18:00</span>
                            </div>
                        </div>
                        <div class="sidebar-reviews">
                            <div class="sidebar-review-title"><i data-lucide="message-circle"></i> Recensioni</div>
                            <div id="sidebarReviewsList">
                                <!-- Recensioni generate da JS -->
                            </div>
                        </div>
                        <div class="sidebar-actions">
                            <a href="#" class="sidebar-btn sidebar-btn-maps" id="sidebarMapsBtn" style="pointer-events: none; opacity: 0.5;" title="Funzionalità non disponibile in locale"><i data-lucide="map"></i> Maps</a>
                            <a href="#" class="sidebar-btn sidebar-btn-contact" id="sidebarContactBtn" style="pointer-events: none; opacity: 0.5;" title="Funzionalità non disponibile in locale"><i data-lucide="mail"></i> Email</a>
                        </div>
                    </div>

                    <button class="reset-btn" onclick="resetFilters()"><i data-lucide="refresh-cw"></i> Reset filtri</button>
                </aside>

                <!-- CONTENITORE DINAMICO: LISTA O MAPPA -->
                <div class="mappa-container" id="dinamicContainer">
                    <!-- Lista filiali (default) -->
                    <div id="filialiListView" class="filiali-list-view">
                        <div class="list-header">
                            <h3 id="listHeaderTitle"><i data-lucide="map-pin"></i> Filiali trovate</h3>
                        </div>
                        <div id="filialiCards" class="filiali-cards">
                            <!-- Cards generate da JS -->
                        </div>
                        <div id="filialiAltreContainer">
                            <!-- Altre filiali generate da JS -->
                        </div>
                    </div>

                    <!-- Mappa (nascosta di default) -->
                    <div id="mapViewContainer" style="display: none; width: 100%;">
                        <button class="back-to-results-btn" onclick="showListInRightPanel()">
                            <i data-lucide="arrow-left"></i> Torna ai risultati
                        </button>
                        <iframe
                            id="googleMap"
                            width="100%"
                            height="550"
                            style="border:0; border-radius: 12px;"
                            loading="lazy"
                            allowfullscreen
                            referrerpolicy="no-referrer-when-downgrade"
                            src="">
                        </iframe>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- VANTAGGI -->
    <section class="vantaggi">
        <div class="container">
            <div class="vantaggi-grid">
                <div class="vantaggio-card">
                    <div class="vantaggio-icon icon-primary"><i data-lucide="users"></i></div>
                    <h3>Consulenza Gratuita</h3>
                    <p>Parlaci delle tue competenze e aspettative, ti indirizziamo verso le migliori opportunità</p>
                </div>
                <div class="vantaggio-card">
                    <div class="vantaggio-icon icon-warning"><i data-lucide="zap"></i></div>
                    <h3>Colloquio in Giornata</h3>
                    <p>Vieni senza appuntamento, i nostri consulenti ti ricevono subito per valutare il tuo profilo</p>
                </div>
                <div class="vantaggio-card">
                    <div class="vantaggio-icon icon-success"><i data-lucide="check-circle"></i></div>
                    <h3>Ti Chiamiamo in 48h</h3>
                    <p>Lasci il CV e ti richiamiamo entro 2 giorni lavorativi con proposte concrete</p>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA FINALE -->
    <section class="cta-finale">
        <div class="container">
            <h2><i data-lucide="smartphone"></i> Non trovi la tua città?</h2>
            <p>Chiamaci o scrivici, ti aiutiamo noi a trovare la soluzione più vicina</p>
            <div class="cta-buttons">
                <a href="tel:02454320" class="cta-button">
                    <i data-lucide="phone"></i> 02/454320
                </a>
                <a href="mailto:info@attal.it" class="cta-button">
                    <i data-lucide="mail"></i> info@attal.it
                </a>
            </div>
        </div>
    </section>

    <!-- Footer incluso dinamicamente -->
    <div id="footer-placeholder"></div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // Database filiali caricato da JSON esterno
        let filiali = [];
        let filialiFiltered = [];

        // Carica filiali da JSON
        async function loadFiliali() {
            try {
                const response = await fetch('../assets/data/filiali.json');
                filiali = await response.json();
                filialiFiltered = [...filiali];
                console.log(`Caricate ${filiali.length} filiali da JSON`);
                // Inizializza la pagina dopo il caricamento
                setupAutocomplete();
                generateFilialiCards();
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) {
                console.error('Errore caricamento filiali:', error);
            }
        }

        // Brand colors
        const brandColors = {
            'Tempus': '#df1d1d',
            'Temporary': '#f18f03',
            'Lavorint': '#4b95cf',
            'Tempor': '#c1172a'
        };

        // Recensioni template
        const recensioniTemplate = [
            { nome: "Marco R.", testo: "Professionali e veloci. Trovato lavoro in 3 giorni!", stelle: 5 },
            { nome: "Laura B.", testo: "Consulenti preparati, mi hanno seguito fino all'assunzione.", stelle: 5 },
            { nome: "Giuseppe M.", testo: "Finalmente un'agenzia seria! Consigliatissimi!", stelle: 5 },
            { nome: "Francesca T.", testo: "Personale cordiale e competente. Ottima esperienza.", stelle: 5 },
            { nome: "Alessandro P.", testo: "Mi hanno aiutato a trovare il lavoro perfetto!", stelle: 5 },
            { nome: "Chiara S.", testo: "Ambiente accogliente, consulenti top.", stelle: 4 },
            { nome: "Roberto V.", testo: "Esperienza positiva. Buona assistenza.", stelle: 4 },
            { nome: "Simona L.", testo: "Finalmente ho trovato stabilità lavorativa!", stelle: 5 }
        ];

        // Posizione simulata: Milano centro
        const MOCK_POSITION = { lat: 45.4642, lng: 9.1900 };

        // Formula Haversine
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function trovaFilialeVicina() {
            const btn = document.getElementById('geoBtn');
            const alert = document.getElementById('geoAlert');
            btn.classList.add('loading');
            btn.querySelector('.geo-text').textContent = 'Rilevamento posizione';

            setTimeout(() => {
                const filialiConDistanza = filiali.map(f => {
                    if (f.lat && f.lng) {
                        const distanza = calculateDistance(MOCK_POSITION.lat, MOCK_POSITION.lng, f.lat, f.lng);
                        return { ...f, distanza: distanza };
                    }
                    return { ...f, distanza: 9999 };
                });
                filialiConDistanza.sort((a, b) => a.distanza - b.distanza);
                const filialiVicine = filialiConDistanza.slice(0, 10);
                const hasFilialeVicina = filialiVicine[0].distanza <= 10;

                if (hasFilialeVicina) {
                    filialiFiltered = filialiVicine;
                    generateFilialiCardsWithDistance();
                    document.querySelector('.filiali-section').scrollIntoView({ behavior: 'smooth' });
                    alert.style.display = 'none';
                } else {
                    alert.style.display = 'flex';
                }
                btn.classList.remove('loading');
                btn.querySelector('.geo-text').textContent = 'Trova filiale vicina';
            }, 800);
        }

        function generateFilialiCardsWithDistance() {
            const container = document.getElementById('filialiCards');
            const headerTitle = document.getElementById('listHeaderTitle');

            if (filialiFiltered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px 0;">Nessuna filiale trovata</p>';
                headerTitle.innerHTML = '<i data-lucide="map-pin"></i> Nessuna filiale trovata';
                return;
            }

            headerTitle.innerHTML = `<i data-lucide="map-pin"></i> ${filialiFiltered.length} ${filialiFiltered.length === 1 ? 'filiale trovata' : 'filiali trovate'}`;

            const top3 = filialiFiltered.slice(0, 3);
            const resto = filialiFiltered.slice(3);
            const altreContainer = document.getElementById('filialiAltreContainer');

            // Cards principali nella griglia
            container.innerHTML = top3.map(f => {
                const filialeJson = JSON.stringify(f).replace(/"/g, '&quot;');
                const distanzaBadge = f.distanza && f.distanza < 9999 ?
                    (f.distanza <= 10 ?
                        `<div class="distanza-badge vicina"><i data-lucide="navigation"></i> A soli ${f.distanza.toFixed(1)} km da te</div>` :
                        `<div class="distanza-badge normale"><i data-lucide="map-pin"></i> ${f.distanza.toFixed(1)} km da te</div>`
                    ) : '';

                return `
                    <div class="filiale-card" onclick='selectFiliale(${filialeJson})'>
                        ${distanzaBadge}
                        <div class="filiale-card-header">
                            <div class="filiale-card-title">${f.citta}</div>
                            <span class="filiale-card-brand" style="background: ${brandColors[f.brand]}">${f.brand}</span>
                        </div>
                        <button class="filiale-card-btn" style="--brand-color: ${brandColors[f.brand]}">Scopri dettagli</button>
                    </div>
                `;
            }).join('');

            // Altre filiali sotto la griglia
            if (resto.length > 0) {
                altreContainer.innerHTML = `
                    <div class="filiali-divider"><span>Altre filiali nelle vicinanze</span></div>
                    <div class="filiali-list-compact">
                        ${resto.map(f => {
                            const filialeJson = JSON.stringify(f).replace(/"/g, '&quot;');
                            const distanzaText = f.distanza && f.distanza < 9999 ? `${f.distanza.toFixed(1)} km` : '-';
                            return `
                                <div class="filiale-compact-item" onclick='selectFiliale(${filialeJson})'>
                                    <span class="filiale-compact-citta">${f.citta}</span>
                                    <span class="filiale-compact-divider">•</span>
                                    <span class="filiale-compact-distanza">${distanzaText}</span>
                                    <span class="filiale-compact-divider">•</span>
                                    <span class="filiale-compact-brand" style="color: ${brandColors[f.brand]}">${f.brand}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                altreContainer.innerHTML = '';
            }

            lucide.createIcons();
        }

        function scrollToManualSearch() {
            document.getElementById('manualSearchSection').scrollIntoView({ behavior: 'smooth' });
        }

        function showFilialeInfo(filiale) {
            const infoBox = document.getElementById('sidebarInfoBox');
            // Usa i dati reali dal JSON
            const rating = filiale.rating ? filiale.rating.toFixed(1) : 'N/A';
            const reviewCount = filiale.reviews || 0;
            const fullStars = filiale.rating ? Math.floor(filiale.rating) : 0;
            const stars = '★'.repeat(fullStars) + '☆'.repeat(5 - fullStars);
            const shuffled = [...recensioniTemplate].sort(() => 0.5 - Math.random());
            const selectedReviews = shuffled.slice(0, 2);

            document.getElementById('sidebarTitle').textContent = filiale.citta;
            document.getElementById('sidebarBrand').textContent = filiale.brand;
            document.getElementById('sidebarBrand').style.background = brandColors[filiale.brand];

            const headerElement = document.querySelector('.sidebar-info-header');
            const brandColor = brandColors[filiale.brand];

            headerElement.style.background = 'transparent';
            headerElement.style.borderBottomColor = brandColor;

            document.getElementById('sidebarStars').textContent = stars;
            document.getElementById('sidebarRating').textContent = rating;
            document.getElementById('sidebarCount').textContent = `(${reviewCount} recensioni)`;
            document.getElementById('sidebarAddress').textContent = filiale.indirizzo;
            document.getElementById('sidebarPhone').href = `tel:${filiale.tel ? filiale.tel.replace(/[\s\/]/g, '') : ''}`;
            document.getElementById('sidebarPhone').textContent = filiale.tel || 'N/A';

            const reviewsHTML = selectedReviews.map(r => `
                <div class="sidebar-review-item">
                    <div class="sidebar-review-header">
                        <span class="sidebar-review-name">${r.nome}</span>
                        <span class="sidebar-review-stars">${'★'.repeat(r.stelle)}${'☆'.repeat(5-r.stelle)}</span>
                    </div>
                    <div class="sidebar-review-text">"${r.testo}"</div>
                </div>
            `).join('');

            document.getElementById('sidebarReviewsList').innerHTML = reviewsHTML;

            const mapsBtn = document.getElementById('sidebarMapsBtn');
            mapsBtn.href = '#';
            mapsBtn.onclick = (e) => { e.preventDefault(); showMapInRightPanel(filiale); };
            document.getElementById('sidebarContactBtn').href = `mailto:${filiale.email}`;

            infoBox.classList.add('show');

            if (filiale.lat && filiale.lng) {
                const iframe = document.getElementById('googleMap');
                iframe.src = `https://www.google.com/maps/embed/v1/view?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&center=${filiale.lat},${filiale.lng}&zoom=15&maptype=roadmap`;
            }
        }

        function setupAutocomplete() {
            const input = document.getElementById('searchInput');
            const dropdown = document.getElementById('autocompleteDropdown');

            input.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase().trim();
                if (value.length < 2) { dropdown.classList.remove('show'); return; }

                const matches = filiali.filter(f => f.citta.toLowerCase().includes(value)).slice(0, 8);
                if (matches.length === 0) { dropdown.classList.remove('show'); return; }

                dropdown.innerHTML = matches.map(f => {
                    const highlighted = f.citta.replace(new RegExp(value, 'gi'), match => `<strong>${match}</strong>`);
                    return `<div class="autocomplete-item" onclick="selectCity('${f.citta}')">${highlighted}<span class="brand-tag" style="background: ${brandColors[f.brand]}">${f.brand}</span></div>`;
                }).join('');
                dropdown.classList.add('show');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-wrapper')) dropdown.classList.remove('show');
            });
        }

        function selectCity(citta) {
            document.getElementById('searchInput').value = citta;
            document.getElementById('autocompleteDropdown').classList.remove('show');
            const filiale = filiali.find(f => f.citta === citta);
            if (filiale) showFilialeInfo(filiale);
            filterFiliali();
        }


        let hasSearched = false;

        function generateFilialiCards() {
            const container = document.getElementById('filialiCards');
            const headerTitle = document.getElementById('listHeaderTitle');
            const altreContainer = document.getElementById('filialiAltreContainer');

            // Pulisci la sezione "altre filiali" (usata solo per geolocalizzazione)
            altreContainer.innerHTML = '';

            if (filialiFiltered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px 0;">Nessuna filiale trovata</p>';
                headerTitle.innerHTML = '<i data-lucide="map-pin"></i> Nessuna filiale trovata';
                return;
            }

            if (hasSearched) {
                headerTitle.innerHTML = `<i data-lucide="map-pin"></i> ${filialiFiltered.length} ${filialiFiltered.length === 1 ? 'filiale trovata' : 'filiali trovate'}`;
            } else {
                headerTitle.innerHTML = '<i data-lucide="map-pin"></i> Tutte le filiali';
            }

            container.innerHTML = filialiFiltered.map(f => {
                const filialeJson = JSON.stringify(f).replace(/"/g, '&quot;');
                return `
                    <div class="filiale-card" onclick='selectFiliale(${filialeJson})'>
                        <div class="filiale-card-header">
                            <div class="filiale-card-title">${f.citta}</div>
                            <span class="filiale-card-brand" style="background: ${brandColors[f.brand]}">${f.brand}</span>
                        </div>
                        <button class="filiale-card-btn" style="--brand-color: ${brandColors[f.brand]}">Scopri dettagli</button>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function selectFiliale(filiale) { showFilialeInfo(filiale); }

        function showMapInRightPanel(filiale) {
            const listView = document.getElementById('filialiListView');
            const mapContainer = document.getElementById('mapViewContainer');
            const mapIframe = document.getElementById('googleMap');
            listView.style.display = 'none';
            mapContainer.style.display = 'block';
            const mapsQuery = encodeURIComponent(`${filiale.indirizzo}, ${filiale.citta}`);
            mapIframe.src = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${mapsQuery}&zoom=15`;
        }

        function showListInRightPanel() {
            document.getElementById('filialiListView').style.display = 'block';
            document.getElementById('mapViewContainer').style.display = 'none';
        }

        function filterFiliali() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const regioneFilter = document.getElementById('regioneFilter').value;
            const brandFilter = document.getElementById('brandFilter').value;

            hasSearched = true;

            filialiFiltered = filiali.filter(filiale => {
                const matchSearch = !searchText || filiale.citta.toLowerCase().includes(searchText) || filiale.indirizzo.toLowerCase().includes(searchText);
                const matchRegione = !regioneFilter || filiale.regione === regioneFilter;
                const matchBrand = !brandFilter || filiale.brand === brandFilter;
                return matchSearch && matchRegione && matchBrand;
            });

            generateFilialiCards();
            showListInRightPanel();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('regioneFilter').value = '';
            document.getElementById('brandFilter').value = '';
            hasSearched = false;
            filialiFiltered = [...filiali];
            generateFilialiCards();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Carica filiali da JSON e inizializza
            loadFiliali();
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') filterFiliali();
            });
            document.getElementById('searchInput').addEventListener('input', () => {
                filterFiliali();
            });
        });
    </script>

    <!-- Componenti Header e Footer -->
    <script src="../assets/js/attal-components.js"></script>
</body>
</html>
